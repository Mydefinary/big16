# gateway/src/main/resources/application.yml

server:
  port: 8000

spring:
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins: "http://20.249.154.2"
            allowedMethods: [GET, POST, PUT, PATCH, DELETE, OPTIONS]
            allowedHeaders: "*"
            allowCredentials: true
            maxAge: 3600
      discovery:
        locator:
          enabled: false

      routes:
        # ===================================================
        # 0. Gateway 자체 Auth Proxy (쿠키 기반 인증)
        # ===================================================
        - id: auth-proxy-routes
          uri: lb://gateway
          predicates:
            - Path=/api/auths/login, /api/auths/logout, /api/auths/check
          order: -1

        # ===================================================
        # 1. 인증 서비스 - 공개 경로 (인증 불필요)
        # ===================================================
        - id: auth-public-routes
          uri: http://auth-backend-service-hoa:8080
          predicates:
            - Path=/api/auths/register, /api/auths/verify-code, /api/auths/resend-code, /api/auths/check-email, /api/auths/check-login-id, /api/auths/refresh, /api/auths/reset-password, /api/auths/health, /api/auths/save-password, /api/auths/test-login, /api/auths/safe-login, /api/auths/check-user/**
          filters:
            - StripPrefix=1
          order: 0

        # ===================================================
        # 2. 사용자 서비스 - 공개 경로 (인증 불필요)
        # ===================================================
        - id: user-public-routes
          uri: http://user-backend-service-hoa:8081
          predicates:
            - Path=/api/users/register, /api/users/check-email, /api/users/find-id, /api/users/health, /api/users/test-json, /api/users/test-complex
          filters:
            - StripPrefix=1
          order: 1

        # ===================================================
        # 3. 인증 서비스 - 보호된 경로 (인증 필요)
        # ===================================================
        - id: auth-secure-routes
          uri: http://auth-backend-service-hoa:8080
          predicates:
            - Path=/api/auths/**
          filters:
            - name: JwtAuthenticationFilter
            - StripPrefix=1
          order: 2

        # ===================================================
        # 4. 사용자 서비스 - 보호된 경로 (인증 필요)
        # ===================================================
        - id: user-secure-routes
          uri: http://user-backend-service-hoa:8081
          predicates:
            - Path=/api/users/**
          filters:
            - name: JwtAuthenticationFilter
            - StripPrefix=1
          order: 3

        # ===================================================
        # 프론트엔드 서비스 라우팅 (실제 서비스 페이지)
        # ===================================================
        # ===================================================
        # 보호된 서비스들 - 메인보다 먼저 처리 (JWT 인증 필요)
        # ===================================================
        
        - id: ppl-gen-frontend
          uri: http://ppl-gen-frontend-service:80
          predicates:
            - Path=/ppl-gen, /ppl-gen/**
          filters:
            - name: JwtAuthenticationFilter
            - StripPrefix=1
          order: 4

        - id: goods-gen-frontend  
          uri: http://goods-gen-frontend-service:80
          predicates:
            - Path=/goods-gen, /goods-gen/**
          filters:
            - name: JwtAuthenticationFilter
            - StripPrefix=1
          order: 5

        - id: webtoon-hl-frontend
          uri: http://webtoon-hl-frontend-service:80
          predicates:
            - Path=/webtoon-hl, /webtoon-hl/**
          filters:
            - name: JwtAuthenticationFilter
            - StripPrefix=1
          order: 6

        - id: webtoon-dashboard-frontend
          uri: http://webtoon-dashboard-frontend-service:80
          predicates:
            - Path=/webtoon-dashboard, /webtoon-dashboard/**
          filters:
            - name: JwtAuthenticationFilter
            - StripPrefix=1
          order: 7

        - id: board-frontend
          uri: http://board-frontend-service:80
          predicates:
            - Path=/board, /board/**
          filters:
            - name: JwtAuthenticationFilter
            - StripPrefix=1
          order: 8

        # ===================================================
        # 메인 프론트엔드 정적 자산 먼저 처리
        # ===================================================
        - id: main-frontend-assets
          uri: http://auth-frontend-service-hoa:80
          predicates:
            - Path=/assets/**, /static/**, /favicon.ico, /vite.svg, /robots.txt, /manifest.json
          order: 90

        # ===================================================
        # 메인 프론트엔드 (기본 경로들만) - 가장 낮은 우선순위
        # ===================================================
        - id: main-frontend
          uri: http://auth-frontend-service-hoa:80
          predicates:
            - Path=/, /login, /register, /email-verification, /find-id, /find-password, /dashboard, /mypage, /faq
          order: 100

        # ===================================================
        # PPL & Goods Generation APIs - 보호된 경로 (인증 필요)
        # ===================================================
        - id: ppl-gen-service
          uri: http://ppl-gen-backend-service:8000
          predicates:
            - Path=/api/ppl-gen/**
          filters:
            - name: JwtAuthenticationFilter
            - StripPrefix=2
          order: 10

        - id: goods-gen-service
          uri: http://goods-gen-backend-service:8001
          predicates:
            - Path=/api/goods-gen/**
          filters:
            - name: JwtAuthenticationFilter
            - StripPrefix=2
          order: 11

        - id: webtoon-dashboard-service
          uri: http://webtoon-dashboard-backend-service:8002
          predicates:
            - Path=/api/webtoon/**
          filters:
            - name: JwtAuthenticationFilter
            - StripPrefix=2
          order: 12

        - id: webtoon-hl-service
          uri: http://webtoon-hl-backend-service:8003
          predicates:
            - Path=/api/webtoon-hl/**
          filters:
            - name: JwtAuthenticationFilter
            - StripPrefix=2
          order: 13

        - id: board-service
          uri: http://board-backend-service:8082
          predicates:
            - Path=/api/board/**
          filters:
            - name: JwtAuthenticationFilter
            - StripPrefix=2
          order: 14

        - id: chatbot-service
          uri: http://chatbot-backend-service:8080
          predicates:
            - Path=/api/chatbot/**
          filters:
            - name: JwtAuthenticationFilter
            - StripPrefix=2
          order: 15


jwt:
  secret: ${JWT_SECRET:your-super-secret-jwt-key-here-make-it-long-and-secure-at-least-32-characters}